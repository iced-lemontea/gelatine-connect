<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jelly Heads | Gelatine Network</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Mint Page Specifics */
        .container {
            max-width: 480px;
        }

        /* Header */
        .logo-container {
            text-align: center;
            margin-bottom: 30px;
        }



        /* NFT Image Area */
        .nft-frame {
            width: 260px;
            height: 260px;
            margin: 0 auto 20px;
            border-radius: 20px;
            border: 2px solid var(--border);
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            box-shadow: 0 0 20px rgba(255, 0, 127, 0.2);
        }

        .jelly-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
            animation: wobble 4s infinite ease-in-out;
        }

        @keyframes wobble {

            0%,
            100% {
                transform: rotate(0deg);
            }

            25% {
                transform: rotate(2deg);
            }

            75% {
                transform: rotate(-2deg);
            }
        }

        /* Stats */
        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 10px;
            border: 1px solid var(--border);
        }

        .stat-val {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--neon-cyan);
            /* mapped from accent */
        }

        /* Main Mint Button - Keep specific gradient */
        button.main-btn {
            background: linear-gradient(45deg, var(--neon-magenta), #ff55aa);
            color: white;
            box-shadow: 0 0 20px rgba(255, 0, 127, 0.4);
        }

        button.main-btn:hover {
            box-shadow: 0 0 30px rgba(255, 0, 127, 0.7);
            transform: translateY(-2px);
        }

        button.main-btn:disabled {
            background: #333;
            box-shadow: none;
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* Status & Links */
        .status-msg {
            margin-top: 15px;
            font-size: 0.9em;
            min-height: 20px;
            font-weight: bold;
        }

        /* === FLOATING NFT BACKGROUNDS === */
        .floating-nfts {
            position: absolute;
            /* Relative to document height */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Will be set dynamically to document height */
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }

        .float-nft {
            position: absolute;
            opacity: 1.0;
            background: rgba(20, 5, 30, 0.4);
            border-radius: 20px;
            padding: 8px;
            border: 2px solid var(--pulse-pink);
            box-shadow: 0 0 15px rgba(250, 0, 255, 0.3), inset 0 0 10px rgba(250, 0, 255, 0.2);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }

        .float-nft:nth-child(even) {
            border-color: var(--pulse-cyan);
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.3), inset 0 0 10px rgba(0, 243, 255, 0.2);
        }

        .float-nft img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 12px;
        }

        @keyframes genericFloat {

            0%,
            100% {
                transform: translate(0, 0) rotate(0deg);
            }

            33% {
                transform: translate(15px, -10px) rotate(1deg);
            }

            66% {
                transform: translate(-10px, 15px) rotate(-1deg);
            }
        }

        @keyframes genericWobble {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-8px);
            }
        }



        /* Wobble animations */
        @keyframes wobbleFloat1 {

            0%,
            100% {
                transform: rotate(-4deg) translateY(0px);
            }

            25% {
                transform: rotate(3deg) translateY(-15px);
            }

            50% {
                transform: rotate(-3deg) translateY(-8px);
            }

            75% {
                transform: rotate(4deg) translateY(-18px);
            }
        }

        @keyframes wobbleFloat2 {

            0%,
            100% {
                transform: rotate(3deg) translateY(0px);
            }

            25% {
                transform: rotate(-4deg) translateY(-12px);
            }

            50% {
                transform: rotate(2deg) translateY(-20px);
            }

            75% {
                transform: rotate(-3deg) translateY(-10px);
            }
        }

        @keyframes wobbleFloat3 {

            0%,
            100% {
                transform: rotate(-3deg) translateY(0px);
            }

            25% {
                transform: rotate(4deg) translateY(-10px);
            }

            50% {
                transform: rotate(-2deg) translateY(-16px);
            }

            75% {
                transform: rotate(3deg) translateY(-8px);
            }
        }

        @keyframes wobbleFloat4 {

            0%,
            100% {
                transform: rotate(2deg) translateY(0px);
            }

            25% {
                transform: rotate(-3deg) translateY(-14px);
            }

            50% {
                transform: rotate(4deg) translateY(-7px);
            }

            75% {
                transform: rotate(-2deg) translateY(-19px);
            }
        }

        /* Drift animations */
        @keyframes floatDrift1 {

            0%,
            100% {
                transform: translate(0, 0);
            }

            33% {
                transform: translate(200px, -150px);
            }

            66% {
                transform: translate(-100px, 100px);
            }
        }

        @keyframes floatDrift2 {

            0%,
            100% {
                transform: translate(0, 0);
            }

            33% {
                transform: translate(-180px, 200px);
            }

            66% {
                transform: translate(150px, -120px);
            }
        }

        @keyframes floatDrift3 {

            0%,
            100% {
                transform: translate(0, 0);
            }

            33% {
                transform: translate(150px, 150px);
            }

            66% {
                transform: translate(-200px, -100px);
            }
        }

        @keyframes floatDrift4 {

            0%,
            100% {
                transform: translate(0, 0);
            }

            33% {
                transform: translate(-150px, -180px);
            }

            66% {
                transform: translate(200px, 150px);
            }
        }

        /* Ensure main content is above */
        body>.container {
            position: relative;
            z-index: 1;
        }

        /* Wallet Settings Section */
        .wallet-tools {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .wallet-tools h3 {
            font-size: 0.8em;
            text-transform: uppercase;
            opacity: 0.5;
            margin: 0 0 5px 0;
            letter-spacing: 1px;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--neon-cyan);
            color: var(--neon-cyan);
            font-size: 0.9em;
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-secondary:hover {
            background: rgba(0, 243, 255, 0.1);
            transform: translateY(-2px);
        }

        .input-group {
            display: flex;
            gap: 5px;
            margin-bottom: 0;
            /* override style.css */
            padding: 0;
            /* override style.css */
            background: transparent;
            /* override style.css */
            border: none;
            /* override style.css */
        }

        .id-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            color: white;
            padding: 10px;
            border-radius: 12px;
            width: 60px;
            text-align: center;
            font-family: 'Space Grotesk', sans-serif;
        }
    </style>
</head>

<body>

    <!-- Floating NFT Backgrounds -->
    <div class="floating-nfts" id="bg-nfts">
        <!-- Generated by JS -->
    </div>

    <div class="nav">
        <a href="index.html">Command Center</a>
        <a href="staking.html">The Fridge</a>
        <a href="swap.html">WiggleSwap</a>
        <a href="free-gifts.html">Free Gifts</a>
        <a href="jam.html">Buy JAM</a>
        <a href="mint.html" class="active">Mint JELLY</a>
        <a href="about.html">About Us</a>
    </div>

    <div class="container">
        <div class="logo-container">
            <div style="font-size: 3em; margin-bottom: 10px;">üëæ</div>
            <h1>Jelly Heads</h1>
            <div class="subhead">Jelly Genesis Collection</div>
        </div>

        <!-- NFT INTRODUCTION SECTION -->
        <div class="card" style="margin-bottom: 30px; cursor: pointer;" onclick="toggleIntro()">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2
                    style="margin: 0; font-size: 1.5em; background: linear-gradient(90deg, var(--pulse-pink), var(--pulse-cyan)); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                    ü´® The Origin of the Wobble</h2>
                <span id="introToggle" style="font-size: 1.5em;">‚ñº</span>
            </div>
            <div id="introContent" style="margin-top: 20px;">
                <p style="font-size: 0.95em; line-height: 1.6; opacity: 0.9;">
                    It started on a Tuesday afternoon in the Gelatine Network's central "Pantry." A high-frequency
                    trader tried to swap 10 million JELLO tokens for a single Pudding cup. The smart contract couldn't
                    handle the sweetness‚Äîit overheated, short-circuited the refrigerator, and accidentally merged the
                    blockchain's core code with a batch of artisanal fruit juice.
                </p>
                <p style="font-size: 0.95em; line-height: 1.6; opacity: 0.9;">
                    When the smoke cleared, the kitchen wasn't a mess. Instead, <strong class="neon-pink">96 little
                        translucent faces</strong> were staring back from the counter. They weren't just dessert
                    anymore. <strong>They were sentient.</strong>
                </p>

                <div
                    style="background: rgba(250, 0, 255, 0.05); border-left: 3px solid var(--pulse-pink); padding: 15px; margin: 20px 0; border-radius: 8px;">
                    <h3 style="margin: 0 0 10px 0; font-size: 1.1em; color: var(--pulse-cyan);">Born to Jiggle</h3>
                    <p style="margin: 0; font-size: 0.9em; opacity: 0.9;">
                        These are the Jello Heads. They don't have bones, they don't have worries, and they definitely
                        don't have a concept of "financial stability." Some are Happy because they're on a decentralized
                        ledger. Others are Anxious because they've seen a spoon. And the Angry ones? Someone probably
                        told them they look like flan.
                    </p>
                </div>

                <h3 style="font-size: 1.2em; margin: 20px 0 15px 0;">üéØ Why You Need a Jello Head</h3>
                <div
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div
                        style="background: rgba(0, 243, 255, 0.05); padding: 15px; border-radius: 12px; border: 1px solid rgba(0, 243, 255, 0.2);">
                        <div style="font-size: 1.5em; margin-bottom: 8px;">‚öõÔ∏è</div>
                        <div style="font-weight: bold; margin-bottom: 5px; color: var(--pulse-cyan);">Anti-Gravity Tech
                        </div>
                        <div style="font-size: 0.85em; opacity: 0.8;">They never lose their shape. Even in a market
                            crash, they just bounce back.</div>
                    </div>
                    <div
                        style="background: rgba(250, 0, 255, 0.05); padding: 15px; border-radius: 12px; border: 1px solid rgba(250, 0, 255, 0.2);">
                        <div style="font-size: 1.5em; margin-bottom: 8px;">üîó</div>
                        <div style="font-weight: bold; margin-bottom: 5px; color: var(--pulse-pink);">The Stickiness
                            Factor</div>
                        <div style="font-size: 0.85em; opacity: 0.8;">The "stickiest" assets on Gelatine chain. Once you
                            buy one, it's hard to let go.</div>
                    </div>
                    <div
                        style="background: rgba(0, 255, 157, 0.05); padding: 15px; border-radius: 12px; border: 1px solid rgba(0, 255, 157, 0.2);">
                        <div style="font-size: 1.5em; margin-bottom: 8px;">üèÜ</div>
                        <div style="font-weight: bold; margin-bottom: 5px; color: var(--pulse-green);">Social Proof
                        </div>
                        <div style="font-size: 0.85em; opacity: 0.8;">Nothing says "I was here at the start" like a
                            Jello Head PFP.</div>
                    </div>
                </div>

                <div
                    style="text-align: center; padding: 20px; background: linear-gradient(135deg, rgba(250, 0, 255, 0.1) 0%, rgba(0, 243, 255, 0.1) 100%); border-radius: 16px; margin-top: 20px;">
                    <p style="font-size: 1.1em; font-weight: bold; margin: 0; font-style: italic;">
                        "They're sweet. They're sentient. And they're looking for a wallet to call home. Don't let them
                        melt‚Äîmint yours today!"
                    </p>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="nft-frame">
                <img id="nftPreview" src="" class="jelly-img" alt="Jelly Preview">
            </div>

            <div class="stat-grid">
                <div class="stat-box">
                    <div class="stat-val">9,999</div>
                    <div class="stat-label">Price (JAM)</div>
                </div>
                <div class="stat-box">
                    <div class="stat-val">#<span id="nextIdDisplay">...</span></div>
                    <div class="stat-label">Next ID</div>
                </div>
            </div>

            <button id="actionBtn" class="main-btn" onclick="connectWallet()">Connect Wallet</button>

            <div id="status" class="status-msg"></div>

            <div class="wallet-tools">
                <h3>Wallet Settings</h3>

                <button class="btn-secondary" onclick="addJamToken()">
                    <span>üíé</span> Add JAM Token to MetaMask
                </button>

                <div class="input-group">
                    <input type="number" id="manualTokenId" class="id-input" placeholder="ID" min="1">
                    <button class="btn-secondary" style="flex:1;" onclick="addNftToWallet()">
                        <span>ü¶ä</span> Add NFT to MetaMask
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---

        // 1. YOUR NFT CONTRACT ADDRESS (Required!)
        const NFT_ADDRESS = "0x8BA26ba701aC69B36Ae3FD34B64B1F3E8eBfbDA3";

        // 2. JAM TOKEN ADDRESS (Fixed based on your prompt)
        const JAM_ADDRESS = "0xcA2144D681137eD0F7A4CCb941fe2d834D1A78bb";

        // 3. Image Base URL (UPDATED WITH CORRECT CID)
        const IMG_BASE_URI = "https://gateway.pinata.cloud/ipfs/bafybeidvaod5ddoxyx5pyq5xbq5umon2b62cclfdlnpncyfp45njy2w67q/";

        // 4. Chain ID (Gelatine Network)
        const CHAIN_ID = "0xF07C"; // Hex for 61564

        // 5. Cost
        const MINT_COST_WEI = 9999000000000000000000n; // 9999 * 10^18

        // --- ABIS ---
        const NFT_ABI = [
            "function nextTokenId() view returns (uint256)",
            "function ownerOf(uint256 tokenId) view returns (address)", // Check if token is minted
            "function totalSupply() view returns (uint256)",
            "function mint() payable"
        ];
        const JAM_ABI = [
            "function balanceOf(address) view returns (uint256)",
            "function allowance(address owner, address spender) view returns (uint256)",
            "function approve(address spender, uint256 amount) returns (bool)"
        ];

        // --- STATE ---
        let provider, signer, userAddress;
        let nftContract, jamContract;
        let currentNextId;
        let currentRandomId; // The random ID we're showing for minting
        let lastMintedId; // Track the ID that was just minted
        let availableIds = []; // Array of unminted token IDs

        // Toggle introduction section
        function toggleIntro() {
            const content = document.getElementById('introContent');
            const toggle = document.getElementById('introToggle');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.innerText = '‚ñº';
            } else {
                content.style.display = 'none';
                toggle.innerText = '‚ñ∂';
            }
        }

        // --- INIT & LOGIC ---

        async function init() {
            generateBgNFTs();
            // Default load - Set simple preview
            document.getElementById("nftPreview").src = IMG_BASE_URI + "1.png";

            if (!window.ethereum) {
                updateStatus("‚ö†Ô∏è Install MetaMask");
                return;
            }
            provider = new ethers.BrowserProvider(window.ethereum);

            try {
                const accounts = await provider.listAccounts();
                if (accounts.length > 0) {
                    await connectWallet();
                } else {
                    updateStatus("‚ö™ Waiting for Connection");
                }
            } catch (e) {
                console.error("Error checking accounts on init:", e);
                updateStatus("‚ö™ Waiting for Connection");
            }
        }

        async function connectWallet() {
            if (!window.ethereum) {
                alert("Please install MetaMask!");
                return;
            }

            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                await provider.send("eth_requestAccounts", []);

                // Check Network
                const network = await provider.getNetwork();
                const expectedChainId = BigInt(parseInt(CHAIN_ID, 16));

                if (network.chainId !== expectedChainId) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: CHAIN_ID }]
                        });
                    } catch (switchError) {
                        // This error code indicates that the chain has not been added to MetaMask.
                        if (switchError.code === 4902) {
                            try {
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: CHAIN_ID,
                                        chainName: 'Gelatine Network',
                                        nativeCurrency: { name: 'JELLO', symbol: 'JELLO', decimals: 18 },
                                        rpcUrls: ['https://rpc.pine.ink']
                                    }]
                                });
                            } catch (addError) { console.error(addError); }
                        }
                        alert("Please switch to Gelatine Network");
                        return;
                    }
                }

                signer = await provider.getSigner();
                userAddress = await signer.getAddress();

                // Init Contracts
                nftContract = new ethers.Contract(NFT_ADDRESS, NFT_ABI, signer);
                jamContract = new ethers.Contract(JAM_ADDRESS, JAM_ABI, signer);

                const btn = document.getElementById("actionBtn"); // Changed from mintBtn to actionBtn
                btn.innerText = "MINT NOW (9999 JAM)";
                btn.onclick = mintNft; // Changed from mintNFT to mintNft
                btn.classList.remove("btn-disabled"); // This class doesn't exist in the original, but keeping it as per instruction
                btn.disabled = false;

                updateStatus("üü¢ Connected: " + userAddress.substring(0, 6) + "...");
                await loadAvailableNFTs();
                await refreshData();

            } catch (error) {
                console.error(error);
                setStatus("Connection failed: " + error.message, "red"); // Changed from updateStatus to setStatus
            }
        }

        window.onload = init;

        // Load all available (unminted) NFT IDs
        async function loadAvailableNFTs() {
            availableIds = [];
            setStatus("üîç Scanning for available Jello Heads...", "white");

            // Check IDs 1-96 for availability
            for (let id = 1; id <= 96; id++) {
                try {
                    // If ownerOf reverts, the token is not minted yet
                    await nftContract.ownerOf(id);
                    // Token exists (has owner), skip it
                } catch (e) {
                    // Token doesn't exist yet, it's available
                    availableIds.push(id);
                }
            }

            if (availableIds.length === 0) {
                setStatus("‚ùå All Jello Heads have been minted!", "#ff4d4d");
                document.getElementById("actionBtn").innerText = "SOLD OUT";
                document.getElementById("actionBtn").disabled = true;
                return;
            }

            // Select a random one from available
            selectRandomNFT();
        }

        // Select and display a random NFT from available IDs
        function selectRandomNFT() {
            if (availableIds.length === 0) return;

            const randomIndex = Math.floor(Math.random() * availableIds.length);
            currentRandomId = availableIds[randomIndex];

            // Update display
            document.getElementById("nextIdDisplay").innerText = currentRandomId;
            document.getElementById("manualTokenId").value = currentRandomId;
            document.getElementById("nftPreview").src = IMG_BASE_URI + currentRandomId + ".png";

            setStatus(`‚úÖ Found ${availableIds.length} available Jello Heads`, "#4caf50");
        }

        async function refreshData() {
            try {
                const btn = document.getElementById("actionBtn");
                btn.disabled = true;
                btn.innerText = "Checking Status...";

                // Note: currentRandomId is already set by loadAvailableNFTs -> selectRandomNFT

                // 2. Check JAM Balance
                const balance = await jamContract.balanceOf(userAddress);

                if (balance < MINT_COST_WEI) {
                    btn.innerText = "Insufficient JAM Balance";
                    btn.disabled = true;
                    setStatus("You need 9999 JAM to mint.", "red");
                    return;
                }

                // 3. Check Allowance
                const allowance = await jamContract.allowance(userAddress, NFT_ADDRESS);

                if (allowance < MINT_COST_WEI) {
                    // Need Approval
                    btn.innerText = "Approve JAM";
                    btn.onclick = approveJam;
                    btn.disabled = false;
                    setStatus("Please approve JAM to continue.", "var(--pulse-pink)");
                } else {
                    // Ready to Mint
                    btn.innerText = "MINT NOW (9999 JAM)";
                    btn.onclick = mintNft;
                    btn.disabled = false;
                    setStatus("Ready to Mint!", "#00F3FF");
                }

            } catch (err) {
                console.error(err);
                setStatus("Error reading contract data. Is contract deployed?", "red");
            }
        }

        async function approveJam() {
            const btn = document.getElementById("actionBtn");
            try {
                setStatus("‚è≥ Approving JAM...", "white");
                btn.disabled = true;

                // Approve max to save gas on future mints
                const tx = await jamContract.approve(NFT_ADDRESS, ethers.MaxUint256);
                await tx.wait();

                setStatus("‚úÖ Approval Successful!", "#00F3FF");
                await refreshData();

            } catch (err) {
                console.error(err);
                setStatus("Approval Failed", "red");
                btn.disabled = false;
            }
        }

        async function mintNft() {
            const btn = document.getElementById("actionBtn");
            try {
                setStatus("‚è≥ Minting Jello Head #" + currentRandomId + "...", "white");
                btn.disabled = true;
                btn.innerText = "MINTING...";

                const tx = await nftContract.mint();
                await tx.wait();

                // Store the minted ID
                lastMintedId = currentRandomId;

                setStatus("üéâ MINT SUCCESSFUL! Jelly Head #" + lastMintedId + " is yours!", "#00F3FF");

                // Automatically prompt to add to MetaMask
                setTimeout(() => {
                    addNftToWallet(lastMintedId);
                }, 1000);

                // Remove minted ID from available list
                availableIds = availableIds.filter(id => id !== lastMintedId);

                // Select another random NFT for next mint
                if (availableIds.length > 0) {
                    selectRandomNFT();
                    await refreshData();
                } else {
                    setStatus("‚ùå All Jello Heads have been minted!", "#ff4d4d");
                    btn.innerText = "SOLD OUT";
                    btn.disabled = true;
                }

            } catch (err) {
                console.error(err);
                setStatus("Mint Failed: " + (err.reason || "Unknown error"), "red");
                btn.disabled = false;
                btn.innerText = "MINT NOW (9999 JAM)";
            }
        }

        function setStatus(msg, color) {
            const el = document.getElementById("status");
            if (el) {
                el.innerText = msg;
                el.style.color = color || "white";
            }
            updateStatus(msg);
        }

        function updateStatus(m) {
            const el = document.getElementById('status-text');
            if (!el) return;
            el.innerText = m;
            if (m.includes("Failed") || m.includes("Error") || m.includes("‚ùå") || m.includes("‚ö†Ô∏è") || m.includes("Wrong") || m.includes("Install")) {
                el.className = "neon-pink";
            } else {
                el.className = "neon-green";
            }
        }

        // --- WALLET TOOLS ---

        async function addJamToken() {
            try {
                await window.ethereum.request({
                    method: 'wallet_watchAsset',
                    params: {
                        type: 'ERC20',
                        options: {
                            address: JAM_ADDRESS,
                            symbol: 'JAM',
                            decimals: 18,
                        },
                    },
                });
            } catch (error) {
                console.error(error);
            }
        }

        async function addNftToWallet(tokenId) {
            // Use provided ID, or lastMintedId, or manual input as fallback
            const idToTrack = tokenId || lastMintedId || document.getElementById("manualTokenId").value;

            if (!idToTrack) {
                alert("Please enter a token ID or mint an NFT first");
                return;
            }

            try {
                await window.ethereum.request({
                    method: 'wallet_watchAsset',
                    params: {
                        type: 'ERC721',
                        options: {
                            address: NFT_ADDRESS,
                            tokenId: String(idToTrack),
                        },
                    },
                });
            } catch (error) {
                console.error(error);
            }
        }

        // --- DYNAMIC BACKGROUND NFTS ---
        function generateBgNFTs() {
            const container = document.getElementById('bg-nfts');
            const total = 10; // Increased to 10 for better coverage
            const ids = new Set();
            while (ids.size < total) {
                ids.add(Math.floor(Math.random() * 96) + 1);
            }
            const idArray = Array.from(ids);

            // Calculate document height to spread NFTs
            const docHeight = Math.max(document.body.scrollHeight, document.documentElement.scrollHeight);
            container.style.height = docHeight + 'px';

            idArray.forEach((id, i) => {
                const div = document.createElement('div');
                div.className = 'float-nft';

                // Original smaller size per user request
                const size = 125 + Math.random() * 50;
                div.style.width = size + 'px';
                div.style.height = size + 'px';

                // Vertical spread across the whole page
                const topPos = (i / total) * 90 + 5; // Spread from 5% to 95%
                div.style.top = topPos + '%';

                // Side positioning (4 or 5 on each side)
                const side = i % 2 === 0 ? 'left' : 'right';
                const sideMargin = 2 + Math.random() * 10;
                if (side === 'left') {
                    div.style.left = sideMargin + '%';
                } else {
                    div.style.right = sideMargin + '%';
                }

                // Random animation properties
                const animDuration = 10 + Math.random() * 10;
                const animDelay = Math.random() * -20;
                div.style.animation = `genericFloat ${animDuration}s ease-in-out ${animDelay}s infinite`;

                const img = document.createElement('img');
                img.src = `${IMG_BASE_URI}${id}.png`;
                img.style.animation = `genericWobble ${4 + Math.random() * 4}s ease-in-out infinite`;

                div.appendChild(img);
                container.appendChild(div);

                // Parallax logic: slightly follow scroll
                const speed = 0.05 + Math.random() * 0.1; // Slow following speed
                window.addEventListener('scroll', () => {
                    const scrolled = window.scrollY;
                    // Move the div slightly down as user scrolls
                    div.style.transform = `translateY(${scrolled * speed}px)`;
                });
            });
        }

        window.onload = init;
    </script>

    <!-- Legal Modal -->
    <div id="legalModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 9999; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box;">
        <div
            style="background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 24px; max-width: 700px; max-height: 80vh; overflow-y: auto; padding: 40px; position: relative;">
            <button onclick="closeLegalModal()"
                style="position: absolute; top: 20px; right: 20px; background: transparent; border: none; color: white; font-size: 2em; cursor: pointer; padding: 0; width: auto;">√ó</button>
            <h2 id="legalModalTitle" style="margin-top: 0; color: var(--pulse-cyan);"></h2>
            <div id="legalModalContent" style="line-height: 1.8; color: rgba(255, 255, 255, 0.9);"></div>
        </div>
    </div>

    <footer style="text-align: center; font-size: 0.8em; opacity: 0.4; padding: 40px 0; margin-top: 40px;">
        <div style="margin-bottom: 10px;">
            <a href="#" onclick="showDisclaimer(); return false;"
                style="color: white; text-decoration: none; margin: 0 10px; border-bottom: 1px dotted white;">Disclaimer</a>
            |
            <a href="#" onclick="showPrivacy(); return false;"
                style="color: white; text-decoration: none; margin: 0 10px; border-bottom: 1px dotted white;">Privacy
                Policy</a>
        </div>
        <div>Developed by <a href="https://www.pine.ink" target="_blank"
                style="color: white; text-decoration: none; border-bottom: 1px dotted white;">Pine Ink Group</a></div>
    </footer>

    <div id="status-bar"
        style="position: fixed; bottom: 20px; right: 20px; font-size: 0.8em; background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.2); z-index: 1000;">
        System: <span id="status-text" class="neon-green">Online</span>
    </div>

    <script src="legal-modals.js"></script>
</body>

</html>