<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jelly Heads | Gelatine Network</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- EXACT STYLES FROM REFERENCE --- */
        :root {
            --bg: #050505;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
            --primary: #FF007F;
            /* Neon Pink */
            --accent: #00F3FF;
            /* Neon Blue */
            --text: #ffffff;
        }

        body {
            background-color: var(--bg);
            background-image:
                radial-gradient(circle at 10% 20%, rgba(255, 0, 127, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(0, 243, 255, 0.15) 0%, transparent 40%);
            color: var(--text);
            font-family: 'Space Grotesk', sans-serif;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            max-width: 480px;
            position: relative;
            z-index: 1;
        }

        /* Nav */
        .nav {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav a {
            color: rgba(255, 255, 255, 0.5);
            text-decoration: none;
            font-weight: bold;
            transition: 0.3s;
            padding-bottom: 5px;
            text-transform: uppercase;
            font-size: 0.9em;
        }

        .nav a.active {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
            text-shadow: 0 0 10px rgba(255, 0, 127, 0.5);
        }

        /* Header */
        .logo-container {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2em;
            margin: 0;
            background: linear-gradient(90deg, var(--primary), #fff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* Glass Card */
        .card {
            background: var(--glass);
            backdrop-filter: blur(16px);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 30px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            text-align: center;
        }

        /* NFT Image Area */
        .nft-frame {
            width: 260px;
            height: 260px;
            margin: 0 auto 20px;
            border-radius: 20px;
            border: 2px solid var(--border);
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            box-shadow: 0 0 20px rgba(255, 0, 127, 0.2);
        }

        .jelly-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
            animation: wobble 4s infinite ease-in-out;
        }

        @keyframes wobble {

            0%,
            100% {
                transform: rotate(0deg);
            }

            25% {
                transform: rotate(2deg);
            }

            75% {
                transform: rotate(-2deg);
            }
        }

        /* Stats */
        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 10px;
            border: 1px solid var(--border);
        }

        .stat-val {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-label {
            font-size: 0.7em;
            opacity: 0.6;
            text-transform: uppercase;
        }

        /* Main Mint Button */
        button.main-btn {
            width: 100%;
            padding: 18px;
            border-radius: 16px;
            border: none;
            font-weight: 700;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Space Grotesk', sans-serif;
            text-transform: uppercase;
            background: linear-gradient(45deg, var(--primary), #ff55aa);
            color: white;
            box-shadow: 0 0 20px rgba(255, 0, 127, 0.4);
        }

        button.main-btn:hover {
            box-shadow: 0 0 30px rgba(255, 0, 127, 0.7);
            transform: translateY(-2px);
        }

        button.main-btn:disabled {
            background: #333;
            box-shadow: none;
            cursor: not-allowed;
            transform: none;
            opacity: 0.7;
        }

        /* Status & Links */
        .status-msg {
            margin-top: 15px;
            font-size: 0.9em;
            min-height: 20px;
            font-weight: bold;
        }

        /* Wallet Settings Section (Styled like secondary actions) */
        .wallet-tools {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .wallet-tools h3 {
            font-size: 0.8em;
            text-transform: uppercase;
            opacity: 0.5;
            margin: 0 0 5px 0;
            letter-spacing: 1px;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--accent);
            color: var(--accent);
            font-size: 0.9em;
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-family: 'Space Grotesk', sans-serif;
        }

        .btn-secondary:hover {
            background: rgba(0, 243, 255, 0.1);
            transform: translateY(-2px);
        }

        .input-group {
            display: flex;
            gap: 5px;
        }

        .id-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            color: white;
            padding: 10px;
            border-radius: 12px;
            width: 60px;
            text-align: center;
            font-family: 'Space Grotesk', sans-serif;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="logo-container">
            <div style="font-size: 3em; margin-bottom: 10px;">üçÆ</div>
            <h1>Jelly Heads</h1>
            <div style="font-size: 0.8em; opacity: 0.7; letter-spacing: 3px; margin-top: 5px;">PFP COLLECTION</div>
        </div>

        <div class="nav">
            <a href="index.html">Command Center</a>
            <a href="swap.html">Swap</a>
            <a href="jam.html">Jam Jar</a>
            <a href="mint.html" class="active">Jelly Heads</a>
        </div>

        <div class="card">
            <div class="nft-frame">
                <img id="nftPreview" src="" class="jelly-img" alt="Jelly Preview">
            </div>

            <div class="stat-grid">
                <div class="stat-box">
                    <div class="stat-val">9,999</div>
                    <div class="stat-label">Price (JAM)</div>
                </div>
                <div class="stat-box">
                    <div class="stat-val">#<span id="nextIdDisplay">...</span></div>
                    <div class="stat-label">Next ID</div>
                </div>
            </div>

            <button id="actionBtn" class="main-btn" onclick="connectWallet()">Connect Wallet</button>

            <div id="status" class="status-msg"></div>

            <div class="wallet-tools">
                <h3>Wallet Settings</h3>

                <button class="btn-secondary" onclick="addJamToken()">
                    <span>üíé</span> Add JAM Token to MetaMask
                </button>

                <div class="input-group">
                    <input type="number" id="manualTokenId" class="id-input" placeholder="ID" min="1">
                    <button class="btn-secondary" style="flex:1;" onclick="addNftToWallet()">
                        <span>ü¶ä</span> Add NFT to MetaMask
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---

        // 1. YOUR NFT CONTRACT ADDRESS (Required!)
        const NFT_ADDRESS = "0x8BA26ba701aC69B36Ae3FD34B64B1F3E8eBfbDA3";

        // 2. JAM TOKEN ADDRESS (Fixed based on your prompt)
        const JAM_ADDRESS = "0xcA2144D681137eD0F7A4CCb941fe2d834D1A78bb";

        // 3. Image Base URL (UPDATED WITH CORRECT CID)
        const IMG_BASE_URI = "https://gateway.pinata.cloud/ipfs/bafybeidvaod5ddoxyx5pyq5xbq5umon2b62cclfdlnpncyfp45njy2w67q/";

        // 4. Chain ID (Gelatine Network)
        const CHAIN_ID = "0xF07C"; // Hex for 61564

        // 5. Cost
        const MINT_COST_WEI = 9999000000000000000000n; // 9999 * 10^18

        // --- ABIS ---
        const NFT_ABI = [
            "function mint() public",
            "function nextTokenId() view returns (uint256)",
            "function totalSupply() view returns (uint256)"
        ];

        const ERC20_ABI = [
            "function approve(address spender, uint256 amount) public returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)",
            "function balanceOf(address account) view returns (uint256)"
        ];

        let provider, signer, nftContract, jamContract;
        let currentNextId = 1;
        let userAddress;

        // --- INIT & LOGIC ---

        async function init() {
            // Default load - Set simple preview
            document.getElementById("nftPreview").src = IMG_BASE_URI + "1.png";
        }

        async function connectWallet() {
            if (!window.ethereum) {
                setStatus("Please install MetaMask!", "red");
                return;
            }

            try {
                provider = new ethers.BrowserProvider(window.ethereum);

                // Switch Chain
                const network = await provider.getNetwork();
                if (network.chainId !== 61564n) {
                    try {
                        await window.ethereum.request({
                            method: "wallet_switchEthereumChain",
                            params: [{ chainId: CHAIN_ID }]
                        });
                    } catch (e) {
                        setStatus("‚ö†Ô∏è Please switch to Gelatine Network", "red");
                        return;
                    }
                }

                signer = await provider.getSigner();
                userAddress = await signer.getAddress();

                // Initialize Contracts
                nftContract = new ethers.Contract(NFT_ADDRESS, NFT_ABI, signer);
                jamContract = new ethers.Contract(JAM_ADDRESS, ERC20_ABI, signer);

                setStatus("Connected: " + userAddress.slice(0, 6) + "...", "#00F3FF");

                // Load Data
                await refreshData();

            } catch (err) {
                console.error(err);
                setStatus("Connection Error", "red");
            }
        }

        async function refreshData() {
            try {
                const btn = document.getElementById("actionBtn");
                btn.disabled = true;
                btn.innerText = "Checking Status...";

                // 1. Get Next ID
                const currentStoredId = await nftContract.nextTokenId();
                currentNextId = Number(currentStoredId) + 1;

                document.getElementById("nextIdDisplay").innerText = currentNextId;
                document.getElementById("manualTokenId").value = currentNextId;

                // Update Image Preview
                document.getElementById("nftPreview").src = IMG_BASE_URI + currentNextId + ".png";

                // 2. Check JAM Balance
                const balance = await jamContract.balanceOf(userAddress);

                if (balance < MINT_COST_WEI) {
                    btn.innerText = "Insufficient JAM Balance";
                    btn.disabled = true;
                    setStatus("You need 9999 JAM to mint.", "red");
                    return;
                }

                // 3. Check Allowance
                const allowance = await jamContract.allowance(userAddress, NFT_ADDRESS);

                if (allowance < MINT_COST_WEI) {
                    // Need Approval
                    btn.innerText = "Approve JAM";
                    btn.onclick = approveJam;
                    btn.disabled = false;
                    setStatus("Please approve JAM to continue.", "var(--primary)");
                } else {
                    // Ready to Mint
                    btn.innerText = "MINT NOW (9999 JAM)";
                    btn.onclick = mintNft;
                    btn.disabled = false;
                    setStatus("Ready to Mint!", "#00F3FF");
                }

            } catch (err) {
                console.error(err);
                setStatus("Error reading contract data. Is contract deployed?", "red");
            }
        }

        async function approveJam() {
            const btn = document.getElementById("actionBtn");
            try {
                setStatus("‚è≥ Approving JAM...", "white");
                btn.disabled = true;

                // Approve max to save gas on future mints
                const tx = await jamContract.approve(NFT_ADDRESS, ethers.MaxUint256);
                await tx.wait();

                setStatus("‚úÖ Approval Successful!", "#00F3FF");
                await refreshData();

            } catch (err) {
                console.error(err);
                setStatus("Approval Failed", "red");
                btn.disabled = false;
            }
        }

        async function mintNft() {
            const btn = document.getElementById("actionBtn");
            try {
                setStatus("‚è≥ Minting Jelly Head...", "var(--primary)");
                btn.disabled = true;
                btn.innerText = "MINTING...";

                const tx = await nftContract.mint();
                await tx.wait();

                setStatus("üéâ MINT SUCCESSFUL!", "#00F3FF");

                // Update UI for next item
                await refreshData();

            } catch (err) {
                console.error(err);
                setStatus("Mint Failed: " + (err.reason || "Unknown error"), "red");
                btn.disabled = false;
                btn.innerText = "MINT NOW (9999 JAM)";
            }
        }

        function setStatus(msg, color) {
            const el = document.getElementById("status");
            el.innerText = msg;
            el.style.color = color || "white";
        }

        // --- WALLET TOOLS ---

        async function addJamToken() {
            try {
                await window.ethereum.request({
                    method: 'wallet_watchAsset',
                    params: {
                        type: 'ERC20',
                        options: {
                            address: JAM_ADDRESS,
                            symbol: 'JAM',
                            decimals: 18,
                        },
                    },
                });
            } catch (error) {
                console.error(error);
            }
        }

        async function addNftToWallet() {
            // Get ID from input or default to current
            const idInput = document.getElementById("manualTokenId").value;
            // Fallback to currentNextId if empty (though logically user usually adds what they just bought)
            const idToTrack = idInput ? idInput : currentNextId;

            if (!idToTrack) return;

            try {
                await window.ethereum.request({
                    method: 'wallet_watchAsset',
                    params: {
                        type: 'ERC721',
                        options: {
                            address: NFT_ADDRESS,
                            tokenId: idToTrack.toString(),
                            symbol: "JELLY",
                            image: IMG_BASE_URI + idToTrack + ".png"
                        },
                    },
                });
            } catch (error) {
                console.error(error);
                alert("Could not add to MetaMask. You may need to verify you own this Token ID.");
            }
        }

        window.onload = init;
    </script>
</body>

</html>