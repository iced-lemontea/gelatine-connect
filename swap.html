<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WiggleSwap | Gelatine Network</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Swap Specific Styles */
        .container {
            max-width: 480px;
        }

        .logo-container {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            font-size: 3em;
            display: inline-block;
            animation: wobble 3s infinite ease-in-out;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.3);
            padding: 5px;
            border-radius: 16px;
            border: 1px solid var(--border);
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            cursor: pointer;
            border-radius: 12px;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.6);
            transition: 0.3s;
            text-transform: uppercase;
        }

        .tab.active {
            background: var(--glass);
            color: var(--pulse-pink);
            border: 1px solid var(--border);
        }

        .swap-box {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 8px;
        }

        .box-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 10px;
        }

        .input-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        input {
            width: 60%;
            font-size: 1.8em;
        }

        .token-badge {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .token-badge:hover {
            border-color: var(--pulse-pink);
        }

        .arrow-container {
            text-align: center;
            margin: -5px 0 5px 0;
            font-size: 1.5em;
            color: var(--pulse-pink);
            cursor: pointer;
            z-index: 10;
            position: relative;
        }

        .btn-wrap {
            background: #4caf50;
            color: white;
            width: 48%;
        }

        .btn-unwrap {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            width: 48%;
            border: 1px solid var(--border);
        }

        #connect-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(5, 5, 5, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
        }

        .connect-btn {
            padding: 15px 40px;
            background: var(--pulse-pink);
            border: none;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1.1em;
            color: #fff;
        }
    </style>
</head>

<body>

    <div class="nav">
        <input type="checkbox" id="nav-check">
        <div class="nav-header">
            <div class="nav-title">Gelatine</div>
        </div>
        <div class="nav-btn">
            <label for="nav-check">
                <span></span>
                <span></span>
                <span></span>
            </label>
        </div>

        <div class="nav-links">
            <a href="index.html">Command Center</a>
            <a href="staking.html">The Fridge</a>
            <a href="swap.html" class="active">WiggleSwap</a>
            <a href="free-gifts.html">Free Gifts</a>
            <a href="jam.html">Buy JAM</a>
            <a href="mint.html">Mint JELLY</a>
            <a href="about.html">About Us</a>
        </div>
    </div>

    <div class="container">
        <div class="logo-container">
            <div class="logo">ü™±</div>
            <h1>WiggleSwap</h1>
            <div class="subhead">Liquid Swaps, Wobbly Gains</div>
        </div>

        <div class="card">
            <div id="connect-overlay">
                <h2 style="color: white; margin-bottom: 10px;">Connect Wallet</h2>
                <div style="font-size: 0.9em; opacity: 0.7; margin-bottom: 20px;">Please connect to Gelatine Network to
                    swap tokens</div>
                <button class="connect-btn" onclick="connectWallet()">‚ö° Connect Wallet</button>
            </div>



            <div id="app-content" style="filter: blur(10px); pointer-events: none; transition: 0.5s;">

                <div class="tabs">
                    <div class="tab active" onclick="switchTab('swap')" id="tab-swap">Swap</div>
                    <div class="tab" onclick="switchTab('pool')" id="tab-pool">Pool</div>
                    <div class="tab" onclick="switchTab('wrap')" id="tab-wrap">Wrap (WJELLO)</div>
                </div>

                <div id="swap-interface">
                    <div class="swap-box">
                        <div class="box-header"><span>You Pay</span><span>Bal: <span id="balFrom">0.0</span></span>
                        </div>
                        <div class="input-row">
                            <input type="number" id="amountIn" placeholder="0" oninput="debouncedQuote()">
                            <div class="token-badge" id="tokenFrom" onclick="toggleDirection()">
                                <span id="symbolFrom">WJELLO</span>
                            </div>
                        </div>
                    </div>

                    <div class="arrow-container" onclick="toggleDirection()">‚¨áÔ∏è</div>

                    <div class="swap-box">
                        <div class="box-header"><span>You Receive (Est.)</span><span>Bal: <span
                                    id="balTo">0.0</span></span></div>
                        <div class="input-row">
                            <input type="number" id="amountOut" placeholder="0.0" disabled>
                            <div class="token-badge" id="tokenTo">
                                <span id="symbolTo">PUD</span>
                            </div>
                        </div>
                    </div>
                    <button class="btn-action btn-primary-action" id="swapBtn" onclick="executeSwap()">Swap
                        Tokens</button>
                </div>

                <div id="wrap-interface" style="display: none;">
                    <p style="text-align: center; font-size: 0.9em; opacity: 0.8; margin-bottom: 20px;">
                        Wrap your JELLO into WJELLO to use it in DeFi applications.
                    </p>
                    <div class="swap-box">
                        <div class="box-header"><span>Input</span><span>Native: <span id="balNative">0.0</span></span>
                        </div>
                        <div class="input-row"><input type="number" id="wrapAmount" placeholder="0">
                            <div class="token-badge">JELLO</div>
                        </div>
                    </div>
                    <div class="arrow-container">‚¨áÔ∏è</div>
                    <div class="swap-box">
                        <div class="box-header"><span>Output</span><span>Wrapped: <span
                                    id="balWrapped">0.0</span></span></div>
                        <div class="input-row"><input type="number" id="wrapAmountOut" placeholder="0.0" disabled>
                            <div class="token-badge">WJELLO</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="btn-wrap" onclick="handleWrap()">Wrap</button>
                        <button class="btn-unwrap" onclick="handleUnwrap()">Unwrap</button>
                    </div>
                </div>

                <div id="pool-interface" style="display: none;">

                    <div class="swap-box"
                        style="background: rgba(255,255,255,0.03); border: 1px solid var(--pulse-purple);">
                        <div class="box-header">
                            <span style="color: var(--pulse-cyan);">Your Liquidity Position</span>
                            <span>LP Tokens: <span id="userLpBal">0.00</span></span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.9em; margin-top: 10px;">
                            <span style="color: rgba(255,255,255,0.6);">Pooled WJELLO:</span>
                            <span id="userPooledWjello" style="font-weight: bold;">0.00</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.9em; margin-top: 5px;">
                            <span style="color: rgba(255,255,255,0.6);">Pooled PUD:</span>
                            <span id="userPooledPud" style="font-weight: bold;">0.00</span>
                        </div>
                        <div
                            style="display: flex; justify-content: space-between; font-size: 0.9em; margin-top: 5px; border-top: 1px dashed #444; padding-top: 5px;">
                            <span style="color: var(--pulse-pink);">Share of Pool:</span>
                            <span id="poolShare" style="font-weight: bold;">0.00%</span>
                        </div>
                    </div>

                    <h3 style="font-size: 0.9em; text-transform: uppercase; color: #888; margin: 15px 0 10px;">Add
                        Liquidity</h3>

                    <div class="swap-box">
                        <div class="box-header"><span>Input WJELLO</span><span>Bal: <span
                                    id="addBalWjello">0.0</span></span></div>
                        <div class="input-row">
                            <input type="number" id="addWjelloAmt" placeholder="0.0"
                                oninput="calcLiquidityQuote('WJELLO')">
                            <div class="token-badge">WJELLO</div>
                        </div>
                    </div>

                    <div class="arrow-container" style="font-size: 1em;">+</div>

                    <div class="swap-box">
                        <div class="box-header"><span>Input PUD</span><span>Bal: <span id="addBalPud">0.0</span></span>
                        </div>
                        <div class="input-row">
                            <input type="number" id="addPudAmt" placeholder="0.0" oninput="calcLiquidityQuote('PUD')">
                            <div class="token-badge">PUD</div>
                        </div>
                    </div>

                    <button class="btn-action btn-primary-action" id="addLiqBtn" onclick="executeAddLiquidity()">‚ûï Add
                        Liquidity</button>

                    <details style="margin-top: 25px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 12px;">
                        <summary
                            style="cursor: pointer; color: var(--pulse-pink); font-size: 0.9em; font-weight: bold;">
                            Remove Liquidity üîª</summary>

                        <div style="margin-top: 15px;">
                            <div class="box-header">
                                <span>Amount to Remove</span>
                                <span id="removePercentDisplay">0%</span>
                            </div>
                            <input type="range" id="removeSlider" min="0" max="100" value="0"
                                style="width: 100%; margin: 15px 0;" oninput="updateRemoveCalc()">

                            <div style="display: flex; justify-content: space-between; font-size: 0.8em; color: #aaa;">
                                <span>You Receive WJELLO: <span id="estRemoveWjello"
                                        style="color: white;">0.0</span></span>
                                <span>You Receive PUD: <span id="estRemovePud" style="color: white;">0.0</span></span>
                            </div>

                            <button class="btn-action btn-secondary-action" style="margin-top: 10px; padding: 12px;"
                                onclick="executeRemoveLiquidity()">Confirm Remove</button>
                        </div>
                    </details>
                </div>

                <div id="status"
                    style="text-align: center; margin-top: 15px; color: var(--text-dim); font-size: 0.9em; min-height: 20px;">
                    Wait for connection...</div>

            </div>
        </div>
    </div>

    <div id="legalModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 9999; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box;">
        <div
            style="background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 24px; max-width: 700px; max-height: 80vh; overflow-y: auto; padding: 40px; position: relative;">
            <button onclick="closeLegalModal()"
                style="position: absolute; top: 20px; right: 20px; background: transparent; border: none; color: white; font-size: 2em; cursor: pointer; padding: 0; width: auto;">√ó</button>
            <h2 id="legalModalTitle" style="margin-top: 0; color: var(--pulse-cyan);"></h2>
            <div id="legalModalContent" style="line-height: 1.8; color: rgba(255, 255, 255, 0.9);"></div>
        </div>
    </div>

    <footer style="text-align: center; font-size: 0.8em; opacity: 0.4; padding: 40px 0; margin-top: 40px;">
        <div>Developed by <a href="#" target="_blank"
                style="color: white; text-decoration: none; border-bottom: 1px dotted white;">Gelatine Labs</a></div>
    </footer>

    <script src="legal-modals.js"></script>

    <script>
        // --- CONFIGURATION ---
        const ROUTER_ADDR = "0x95a3d2Bf633D6fdd8Fbf0824913096B9C1754eBf";
        const FACTORY_ADDR = "0x229F29B59cA4542CfAaC930eECeBfE09d94E03B9";
        const WJELLO_ADDR = "0xd5d395383Edddb48643bC19870308918670Fc80D";
        const PUD_ADDR = "0xdDD5e1b52670667Fd7F38f8B7F8CcBc007fB9B97";
        const CHAIN_ID = 61564n;

        let provider, signer, userAddress;
        let isWjelloToPud = true;
        let quoteTimeout;
        let pairAddress = null;

        // Expanded ABIs for Pool Functions
        const ROUTER_ABI = [
            "function getAmountsOut(uint amountIn, address[] path) view returns (uint[] amounts)",
            "function swapExactTokensForTokens(uint amountIn, uint amountOutMin, address[] path, address to, uint deadline) returns (uint[] amounts)",
            "function addLiquidity(address tokenA, address tokenB, uint amountADesired, uint amountBDesired, uint amountAMin, uint amountBMin, address to, uint deadline) returns (uint amountA, uint amountB, uint liquidity)",
            "function removeLiquidity(address tokenA, address tokenB, uint liquidity, uint amountAMin, uint amountBMin, address to, uint deadline) returns (uint amountA, uint amountB)",
            "function quote(uint amountA, uint reserveA, uint reserveB) pure returns (uint amountB)"
        ];
        const FACTORY_ABI = ["function getPair(address tokenA, address tokenB) view returns (address pair)"];
        const PAIR_ABI = [
            "function getReserves() view returns (uint112, uint112, uint32)",
            "function totalSupply() view returns (uint)",
            "function balanceOf(address) view returns (uint)",
            "function approve(address, uint) returns (bool)",
            "function token0() view returns (address)"
        ];
        const ERC20_ABI = [
            "function approve(address spender, uint amount) returns (bool)",
            "function balanceOf(address) view returns (uint)",
            "function allowance(address owner, address spender) view returns (uint)"
        ];
        const WJELLO_ABI = ["function deposit() payable", "function withdraw(uint amount)"];

        async function init() {
            if (!window.ethereum) return updateStatus("‚ö†Ô∏è Install MetaMask");
            provider = new ethers.BrowserProvider(window.ethereum);

            try {
                const accounts = await provider.listAccounts();
                if (accounts.length > 0) {
                    connectWallet();
                } else {
                    updateStatus("‚ö™ Waiting for Connection");
                }
            } catch (e) { updateStatus("‚ö™ Waiting for Connection"); }
        }
        async function connectWallet() {
            if (!window.ethereum) return alert("Install MetaMask");
            provider = new ethers.BrowserProvider(window.ethereum);
            try {
                await provider.send("eth_requestAccounts", []);
                const net = await provider.getNetwork();
                if (net.chainId !== CHAIN_ID) {
                    try { await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: "0xF07C" }] }); }
                    catch (e) { alert("Wrong Network! Please switch to Gelatine Network."); return; }
                }
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();

                document.getElementById('connect-overlay').style.display = 'none';
                document.getElementById('app-content').style.filter = 'none';
                document.getElementById('app-content').style.pointerEvents = 'auto';
                updateBalances();

                // Initialize wrap listeners
                const wrapIn = document.getElementById('wrapAmount');
                if (wrapIn) {
                    wrapIn.addEventListener('input', (e) => {
                        document.getElementById('wrapAmountOut').value = e.target.value;
                    });
                }
                setStatus("Ready", "#4caf50");
            } catch (e) { alert(e.message); }
        }

        function switchTab(mode) {
            document.getElementById('tab-swap').className = mode === 'swap' ? 'tab active' : 'tab';
            document.getElementById('tab-wrap').className = mode === 'wrap' ? 'tab active' : 'tab';
            document.getElementById('tab-pool').className = mode === 'pool' ? 'tab active' : 'tab';

            document.getElementById('swap-interface').style.display = mode === 'swap' ? 'block' : 'none';
            document.getElementById('wrap-interface').style.display = mode === 'wrap' ? 'block' : 'none';
            document.getElementById('pool-interface').style.display = mode === 'pool' ? 'block' : 'none';

            if (mode === 'pool' && signer) updatePoolStats();
            if (signer) updateBalances();
        }

        // --- SWAP FUNCTIONS ---
        function toggleDirection() {
            isWjelloToPud = !isWjelloToPud;
            document.getElementById('symbolFrom').innerText = isWjelloToPud ? "WJELLO" : "PUD";
            document.getElementById('symbolTo').innerText = isWjelloToPud ? "PUD" : "WJELLO";
            document.getElementById('amountIn').value = "";
            document.getElementById('amountOut').value = "";
            updateBalances();
        }

        async function updateBalances() {
            if (!signer) return;
            const pud = new ethers.Contract(PUD_ADDR, ERC20_ABI, signer);
            const wjello = new ethers.Contract(WJELLO_ADDR, ERC20_ABI, signer);

            try {
                const nBal = await provider.getBalance(userAddress);
                const wBal = await wjello.balanceOf(userAddress);
                const pBal = await pud.balanceOf(userAddress);

                const wFmt = parseFloat(ethers.formatEther(wBal)).toFixed(2);
                const pFmt = parseFloat(ethers.formatEther(pBal)).toFixed(2);

                document.getElementById('balFrom').innerText = isWjelloToPud ? wFmt : pFmt;
                document.getElementById('balTo').innerText = isWjelloToPud ? pFmt : wFmt;
                document.getElementById('balNative').innerText = parseFloat(ethers.formatEther(nBal)).toFixed(2);
                document.getElementById('balWrapped').innerText = wFmt;
            } catch (e) { console.error("Balance fetch error", e); }
        }

        function debouncedQuote() { clearTimeout(quoteTimeout); quoteTimeout = setTimeout(getQuote, 500); }

        async function getQuote() {
            const amt = document.getElementById('amountIn').value;
            if (!amt || parseFloat(amt) <= 0) return;
            if (!signer) return;

            const router = new ethers.Contract(ROUTER_ADDR, ROUTER_ABI, signer);
            const path = isWjelloToPud ? [WJELLO_ADDR, PUD_ADDR] : [PUD_ADDR, WJELLO_ADDR];

            try {
                setStatus("Fetching quote...", "#f2a900");
                const weiIn = ethers.parseEther(amt);
                const amounts = await router.getAmountsOut(weiIn, path);
                document.getElementById('amountOut').value = parseFloat(ethers.formatEther(amounts[1])).toFixed(6);
                setStatus("‚úì Quote ready", "#4caf50");
            } catch (e) {
                console.error(e);
                document.getElementById('amountOut').value = "‚Äî";
                if (e.message && e.message.includes("INSUFFICIENT_LIQUIDITY")) {
                    setStatus("‚ö†Ô∏è Pool is empty! Use Pool tab.", "#ff4d4d");
                }
            }
        }

        async function executeSwap() {
            const amt = document.getElementById('amountIn').value;
            if (!amt) return;
            setStatus("Processing...", "#f2a900");

            const tokenFromAddr = isWjelloToPud ? WJELLO_ADDR : PUD_ADDR;
            const weiIn = ethers.parseEther(amt);
            const deadline = Math.floor(Date.now() / 1000) + 1200;

            try {
                const token = new ethers.Contract(tokenFromAddr, ERC20_ABI, signer);
                const router = new ethers.Contract(ROUTER_ADDR, ROUTER_ABI, signer);

                setStatus("Approving...", "#f2a900");
                await (await token.approve(ROUTER_ADDR, weiIn)).wait();

                setStatus("Swapping...", "#f2a900");
                const path = isWjelloToPud ? [WJELLO_ADDR, PUD_ADDR] : [PUD_ADDR, WJELLO_ADDR];

                // 10% Slippage
                const tx = await router.swapExactTokensForTokens(weiIn, 0, path, userAddress, deadline);
                await tx.wait();

                setStatus("‚úÖ Swap Complete!", "#4caf50");
                updateBalances();
            } catch (e) {
                console.error(e);
                setStatus("‚ùå Failed: " + (e.reason || "Error"), "#ff4d4d");
            }
        }

        // --- POOL FUNCTIONS ---
        async function getPairAddress() {
            if (pairAddress) return pairAddress;
            const factory = new ethers.Contract(FACTORY_ADDR, FACTORY_ABI, provider);
            pairAddress = await factory.getPair(WJELLO_ADDR, PUD_ADDR);
            return pairAddress;
        }

        async function updatePoolStats() {
            if (!signer) return;
            const pairAddr = await getPairAddress();

            if (pairAddr === ethers.ZeroAddress) {
                document.getElementById('poolShare').innerText = "Pool Not Created";
                return;
            }

            const pair = new ethers.Contract(pairAddr, PAIR_ABI, signer);
            const wjello = new ethers.Contract(WJELLO_ADDR, ERC20_ABI, signer);
            const pud = new ethers.Contract(PUD_ADDR, ERC20_ABI, signer);

            // Balances for Input
            const wBal = await wjello.balanceOf(userAddress);
            const pBal = await pud.balanceOf(userAddress);
            document.getElementById('addBalWjello').innerText = parseFloat(ethers.formatEther(wBal)).toFixed(2);
            document.getElementById('addBalPud').innerText = parseFloat(ethers.formatEther(pBal)).toFixed(2);

            // Pool Stats
            const totalLP = await pair.totalSupply();
            const userLP = await pair.balanceOf(userAddress);
            const reserves = await pair.getReserves();
            const token0 = await pair.token0();

            // Identify which reserve is which
            const resWjello = token0.toLowerCase() === WJELLO_ADDR.toLowerCase() ? reserves[0] : reserves[1];
            const resPud = token0.toLowerCase() === PUD_ADDR.toLowerCase() ? reserves[0] : reserves[1];

            let share = 0;
            if (totalLP > 0) {
                share = (parseFloat(userLP) / parseFloat(totalLP)) * 100;
                // Calculate underlying
                const userWjello = (BigInt(userLP) * BigInt(resWjello)) / BigInt(totalLP);
                const userPud = (BigInt(userLP) * BigInt(resPud)) / BigInt(totalLP);

                document.getElementById('userPooledWjello').innerText = parseFloat(ethers.formatEther(userWjello)).toFixed(2);
                document.getElementById('userPooledPud').innerText = parseFloat(ethers.formatEther(userPud)).toFixed(2);
            }

            document.getElementById('userLpBal').innerText = parseFloat(ethers.formatEther(userLP)).toFixed(4);
            document.getElementById('poolShare').innerText = share.toFixed(4) + "%";
        }

        async function calcLiquidityQuote(changedInput) {
            const pairAddr = await getPairAddress();
            if (!pairAddr || pairAddr === ethers.ZeroAddress) return;

            const router = new ethers.Contract(ROUTER_ADDR, ROUTER_ABI, signer);
            const pair = new ethers.Contract(pairAddr, PAIR_ABI, provider);
            const reserves = await pair.getReserves();
            const token0 = await pair.token0();

            const resWjello = token0.toLowerCase() === WJELLO_ADDR.toLowerCase() ? reserves[0] : reserves[1];
            const resPud = token0.toLowerCase() === PUD_ADDR.toLowerCase() ? reserves[0] : reserves[1];

            // If pool is empty, no quote possible, user sets price
            if (resWjello == 0 || resPud == 0) return;

            if (changedInput === 'WJELLO') {
                const amtIn = document.getElementById('addWjelloAmt').value;
                if (!amtIn) return;
                const weiIn = ethers.parseEther(amtIn);
                const quote = await router.quote(weiIn, resWjello, resPud);
                document.getElementById('addPudAmt').value = ethers.formatEther(quote);
            } else {
                const amtIn = document.getElementById('addPudAmt').value;
                if (!amtIn) return;
                const weiIn = ethers.parseEther(amtIn);
                const quote = await router.quote(weiIn, resPud, resWjello);
                document.getElementById('addWjelloAmt').value = ethers.formatEther(quote);
            }
        }

        async function executeAddLiquidity() {
            const wAmt = document.getElementById('addWjelloAmt').value;
            const pAmt = document.getElementById('addPudAmt').value;
            if (!wAmt || !pAmt) return alert("Enter amounts");

            setStatus("Checking Approvals...", "#f2a900");

            const wjello = new ethers.Contract(WJELLO_ADDR, ERC20_ABI, signer);
            const pud = new ethers.Contract(PUD_ADDR, ERC20_ABI, signer);
            const router = new ethers.Contract(ROUTER_ADDR, ROUTER_ABI, signer);

            const wWei = ethers.parseEther(wAmt);
            const pWei = ethers.parseEther(pAmt);
            const deadline = Math.floor(Date.now() / 1000) + 1200;

            try {
                // 1. Approve WJELLO
                const wAllow = await wjello.allowance(userAddress, ROUTER_ADDR);
                if (wAllow < wWei) {
                    setStatus("Approving WJELLO...", "#f2a900");
                    await (await wjello.approve(ROUTER_ADDR, wWei)).wait();
                }

                // 2. Approve PUD
                const pAllow = await pud.allowance(userAddress, ROUTER_ADDR);
                if (pAllow < pWei) {
                    setStatus("Approving PUD...", "#f2a900");
                    await (await pud.approve(ROUTER_ADDR, pWei)).wait();
                }

                // 3. Add Liquidity
                setStatus("Adding Liquidity...", "#f2a900");
                const minA = (wWei * 90n) / 100n; // 10% tolerance
                const minB = (pWei * 90n) / 100n;

                const tx = await router.addLiquidity(
                    WJELLO_ADDR, PUD_ADDR,
                    wWei, pWei,
                    minA, minB,
                    userAddress, deadline
                );
                await tx.wait();

                setStatus("‚úÖ Liquidity Added!", "#4caf50");
                updatePoolStats();
                document.getElementById('addWjelloAmt').value = "";
                document.getElementById('addPudAmt').value = "";
            } catch (e) {
                console.error(e);
                setStatus("‚ùå Failed: " + (e.reason || "Error"), "#ff4d4d");
            }
        }

        // --- REMOVE LIQUIDITY ---
        async function updateRemoveCalc() {
            const percent = document.getElementById('removeSlider').value;
            document.getElementById('removePercentDisplay').innerText = percent + "%";

            const userWjello = document.getElementById('userPooledWjello').innerText;
            const userPud = document.getElementById('userPooledPud').innerText;

            if (userWjello && userPud) {
                const estW = (parseFloat(userWjello) * percent) / 100;
                const estP = (parseFloat(userPud) * percent) / 100;
                document.getElementById('estRemoveWjello').innerText = estW.toFixed(4);
                document.getElementById('estRemovePud').innerText = estP.toFixed(4);
            }
        }

        async function executeRemoveLiquidity() {
            const percent = document.getElementById('removeSlider').value;
            if (percent == 0) return;

            const pairAddr = await getPairAddress();
            const pair = new ethers.Contract(pairAddr, PAIR_ABI, signer);
            const router = new ethers.Contract(ROUTER_ADDR, ROUTER_ABI, signer);

            try {
                setStatus("Reading Position...", "#f2a900");
                const userLP = await pair.balanceOf(userAddress);
                const removeAmt = (userLP * BigInt(percent)) / 100n;

                setStatus("Approving LP Token...", "#f2a900");
                await (await pair.approve(ROUTER_ADDR, removeAmt)).wait();

                setStatus("Removing Liquidity...", "#f2a900");
                const deadline = Math.floor(Date.now() / 1000) + 1200;

                await (await router.removeLiquidity(
                    WJELLO_ADDR, PUD_ADDR,
                    removeAmt,
                    0, 0,
                    userAddress, deadline
                )).wait();

                setStatus("‚úÖ Liquidity Removed!", "#4caf50");
                updatePoolStats();
                document.getElementById('removeSlider').value = 0;
                updateRemoveCalc();

            } catch (e) {
                console.error(e);
                setStatus("‚ùå Remove Failed", "#ff4d4d");
            }
        }

        // --- WRAP FUNCTIONS ---
        async function handleWrap() {
            const amt = document.getElementById('wrapAmount').value;
            if (!amt) return;
            setStatus("Wrapping...", "#f2a900");
            const wjello = new ethers.Contract(WJELLO_ADDR, WJELLO_ABI, signer);
            try {
                await (await wjello.deposit({ value: ethers.parseEther(amt) })).wait();
                setStatus("‚úÖ Wrapped", "#4caf50");
                updateBalances();
            } catch (e) { setStatus("Failed", "#ff4d4d"); }
        }

        async function handleUnwrap() {
            const amt = document.getElementById('wrapAmount').value;
            if (!amt) return;
            setStatus("Unwrapping...", "#f2a900");
            const wjello = new ethers.Contract(WJELLO_ADDR, WJELLO_ABI, signer);
            try {
                await (await wjello.withdraw(ethers.parseEther(amt))).wait();
                setStatus("‚úÖ Unwrapped", "#4caf50");
                updateBalances();
            } catch (e) { setStatus("Failed", "#ff4d4d"); }
        }

        function setStatus(msg, color) {
            const el = document.getElementById('status');
            if (el) {
                el.innerText = msg;
                el.style.color = color;
            }
            updateStatus(msg);
        }

        function updateStatus(m) {
            const el = document.getElementById('status-text');
            if (!el) return;
            el.innerText = m;
            if (m.includes("Failed") || m.includes("Error") || m.includes("‚ùå") || m.includes("‚ö†Ô∏è") || m.includes("Wrong") || m.includes("Install")) {
                el.className = "neon-pink";
            } else {
                el.className = "neon-green";
            }
        }

        function showDisclaimer() { alert("Disclaimer: This is a testnet."); }
        function showPrivacy() { alert("Privacy: No data collected."); }
        function closeLegalModal() { document.getElementById('legalModal').style.display = 'none'; }
    </script>
    <div id="status-bar"
        style="position: fixed; bottom: 20px; right: 20px; font-size: 0.8em; background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.2); z-index: 1000;">
        System: <span id="status-text" class="neon-green">Online</span>
    </div>

</body>

</html>